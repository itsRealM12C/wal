<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>webOS Launcher + Menus (Recode)</title>
<style>
  :root{ --bg:#0b0b0b; --panel:#121212; --panel-2:#181818; --muted:#9aa0a6; --accent:#dcdcdc }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Arial, sans-serif;overflow:hidden}
  .widget{
    position:absolute;
    min-width:200px;
    max-width:360px;
    background:linear-gradient(180deg,var(--panel),var(--panel-2));
    border:1px solid rgba(255,255,255,.06);
    border-radius:10px;
    box-shadow:0 8px 20px rgba(0,0,0,.6);
    padding:8px;
    user-select:none;
  }
  .widget .title{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    cursor:grab;
  }
  .widget .title h1{margin:6px 0;font-size:16px;color:var(--accent);text-shadow:0 0 4px #000}
  .widget .controls{margin-top:8px}
  .btn{display:block;width:100%;margin:6px 0;padding:10px;background:linear-gradient(#303030,#1a1a1a);border:2px solid #555;border-radius:10px;color:#fff;font-weight:700;cursor:pointer;box-shadow:0 4px 6px rgba(0,0,0,.6);text-align:left}
  .btn.small{padding:6px;font-size:13px;border-radius:8px}
  .btn:hover{background:linear-gradient(#444,#222);border-color:#888}
  .muted{opacity:.8;font-size:12px}
  /* specific widgets positions */
  #mainUI{left:12px;top:12px;width:260px}
  #volumeUI{right:12px;top:40%;width:220px;transform:translateY(-50%)}
  /* dialogs turned into widgets but hidden initially */
  .dialog{display:none;z-index:99;min-width:240px}
  /* log */
  #log{
    position:absolute;left:12px;bottom:12px;right:12px;height:28vh;max-height:36vh;overflow:auto;background:rgba(255,255,255,.03);
    padding:10px;border-radius:10px;font-size:12px;color:var(--muted);white-space:pre-wrap;border:1px solid rgba(255,255,255,.03)
  }
  /* header action icons */
  .title .actions{display:flex;gap:6px;align-items:center}
  .icon{width:26px;height:26px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;background:rgba(255,255,255,.02);color:var(--muted);font-weight:700}
  .icon:hover{background:rgba(255,255,255,.04)}
  /* make focus visible */
  button:focus{outline:2px solid rgba(200,200,255,.08);outline-offset:2px}
  /* responsive tweak */
  @media(max-width:720px){ #mainUI{left:8px;top:8px;width:46vw} #volumeUI{right:8px;top:35%} }
  

  
</style>
</head>
<body>

<!-- MAIN LAUNCHER WIDGET -->
<div id="mainUI" class="widget" data-widget>
  <div class="title" data-drag-handle>
    <h1>üì∫ Launcher</h1>
    <div class="actions">
      <div class="icon" title="Drag">‚ò∞</div>
      <div class="icon" id="minMain" title="Hide">‚Äì</div>
    </div>
  </div>

  <div class="controls" id="mainControls">
    <button class="btn" onclick="launchApp('com.webos.app.browser')">Web Browser</button>
    <button class="btn" onclick="launchApp('com.webos.app.cheeringtv')">Cheering TV</button>
    <button class="btn" onclick="launchApp('com.palm.app.settings')">Settings</button>
    <button class="btn" onclick="launchApp('com.webos.app.installation')">Secret Menu</button>
    <button class="btn" onclick="launchApp('com.webos.app.discovery')">LG Store</button>

    <div style="margin-top:8px">
      <h1 style="font-size:14px;margin:6px 0 4px">üéÆ TV Controls <small class="muted">(data-key)</small></h1>
      <button class="btn small" data-key="FRONTKEY_INPUT_SELECT" onclick="sendKey(this)">Input</button>
      <button class="btn small" data-key="MENU" onclick="sendKey(this)">Quick Settings</button>
      <button class="btn small" data-key="PAIRING_M4" onclick="sendKey(this)">LG Magic Remote Pair</button>
    </div>

    <div style="margin-top:8px">
      <h1 style="font-size:14px;margin:6px 0 4px">üéõÔ∏è Menus</h1>
      <button class="btn" id="pcmBtn">PCM Sounds</button>
      <button class="btn" id="tvHotkeyMenuBtn">TVHotkey Menu</button>
      <button class="btn" id="otherMenuBtn">Other Menu</button>
    </div>
  </div>
</div>

<!-- VOLUME WIDGET -->
<div id="volumeUI" class="widget" data-widget>
  <div class="title" data-drag-handle>
    <h1>üîä Volume</h1>
    <div class="actions">
      <div class="icon" id="minVol" title="Hide">‚Äì</div>
    </div>
  </div>
  <div class="controls">
    <button class="btn" onclick="volumeUp()">Volume Up</button>
    <button class="btn" onclick="volumeDown()">Volume Down</button>
    <button class="btn" onclick="toggleMute()">Mute</button>
    <div class="muted" style="margin-top:8px">Current: <span id="volVal">10</span> -- Muted: <span id="muteVal">false</span></div>
    <div id="volumeUI">
  <div class="dragHandle"><p></p></div>
  <input type="number" id="volumeInput" placeholder="Enter number" class="btn" style="width:120px;display:inline-block;margin:5px 5px 5px 0;">
  <button class="btn" style="width:80px;display:inline-block;" onclick="setVolumeFromInput()">Set</button>
</div>

  </div>
</div>

<!-- Volume Setter -->
<style>#inputsUI {
  position: absolute;
  top: 10%;
  right: 20px;
  width: 260px;
  background: rgba(20,20,20,0.9);
  padding: 10px;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0,0,0,.6);
}

.input-row {
  display: flex;
  flex-wrap: wrap;
  margin-bottom: 5px;
}

.input-btn {
  flex: 1 1 48%;
  margin: 2px;
  padding: 8px;
  background: linear-gradient(#303030,#1a1a1a);
  border: 2px solid #555;
  border-radius: 10px;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  text-align: center;
}

.input-btn:hover {
  background: linear-gradient(#444,#222);
  border-color:#888;
}</style>

<script
// Make Inputs panel draggable
makeDraggable(document.getElementById("inputsUI"));

// Reference full-screen video
const fullScreenVideo = document.getElementById("fullScreenVideo");

// Play selected input full screen
const inputBtns = document.querySelectorAll("#inputsUI .input-btn");
inputBtns.forEach(btn => {
  btn.addEventListener("click", () => {
    const src = btn.dataset.src;
    fullScreenVideo.src = src;
    fullScreenVideo.style.display = "block";
    fullScreenVideo.play();
  });
});

// Exit full-screen video on ESC or click
document.addEventListener("keydown", e => {
  if (fullScreenVideo.style.display === "block") {
    if (e.key === "Escape" || e.key === "Backspace") {
      fullScreenVideo.pause();
      fullScreenVideo.style.display = "none";
      fullScreenVideo.src = "";
    }
  }
});

fullScreenVideo.addEventListener("click", () => {
  fullScreenVideo.pause();
  fullScreenVideo.style.display = "none";
  fullScreenVideo.src = "";
});
<!-- Inputs Panel -->
<div id="inputsUI">
  <div class="dragHandle">üéõÔ∏è Inputs</div>
  <div class="input-row">
    <button class="input-btn" data-src="ext://hdmi:1">HDMI 1</button>
    <button class="input-btn" data-src="ext://hdmi:2">HDMI 2</button>
    <button class="input-btn" data-src="ext://hdmi:3">HDMI 3</button>
    <button class="input-btn" data-src="ext://hdmi:4">HDMI 4</button>
  </div>
  <div class="input-row">
    <button class="input-btn" data-src="ext://comp:1">Component 1</button>
    <button class="input-btn" data-src="ext://av:1">AV 1</button>
    <button class="input-btn" data-src="ext://av:2">AV 2</button>
    <button class="input-btn" data-src="ext://scart:1">SCART 1</button>
  </div>
  <div class="input-row">
    <button class="input-btn" data-src="atv://cable:1/dvb/1">Live TV 1</button>
    <button class="input-btn" data-src="atv://cable:2/dvb/2">Live TV 2</button>
  </div>
</div>

<!-- Inputs Panel -->
<div id="inputsUI">
  <div class="dragHandle">üéõÔ∏è Inputs</div>
  <div class="input-row">
    <button class="input-btn" data-src="ext://hdmi:1">HDMI 1</button>
    <button class="input-btn" data-src="ext://hdmi:2">HDMI 2</button>
    <button class="input-btn" data-src="ext://hdmi:3">HDMI 3</button>
    <button class="input-btn" data-src="ext://hdmi:4">HDMI 4</button>
  </div>
  <div class="input-row">
    <button class="input-btn" data-src="ext://comp:1">Component 1</button>
    <button class="input-btn" data-src="ext://av:1">AV 1</button>
    <button class="input-btn" data-src="ext://av:2">AV 2</button>
    <button class="input-btn" data-src="ext://scart:1">SCART 1</button>
  </div>
  <div class="input-row">
    <button class="input-btn" data-src="atv://cable:1/dvb/1">Live TV 1</button>
    <button class="input-btn" data-src="atv://cable:2/dvb/2">Live TV 2</button>
  </div>
</div>

<video id="fullScreenVideo" autoplay style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999;"></video>

<style>
#inputsUI{position:absolute;top:10%;right:20px;width:260px;background:rgba(20,20,20,0.9);padding:10px;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.6);}
.input-row{display:flex;flex-wrap:wrap;margin-bottom:5px;}
.input-btn{flex:1 1 48%;margin:2px;padding:8px;background:linear-gradient(#303030,#1a1a1a);border:2px solid #555;border-radius:10px;color:#fff;font-weight:bold;cursor:pointer;text-align:center;}
.input-btn:hover{background:linear-gradient(#444,#222);border-color:#888;}
.dragHandle{cursor:move;font-weight:bold;margin-bottom:6px;}
</style>

<script>
// Make draggable
function makeDraggable(el){let isDown=false,offsetX,offsetY;const handle=el.querySelector('.dragHandle');handle.onmousedown=function(e){isDown=true;offsetX=e.clientX-el.offsetLeft;offsetY=e.clientY-el.offsetTop;document.body.style.userSelect='none';};document.onmouseup=function(){isDown=false;document.body.style.userSelect='auto';};document.onmousemove=function(e){if(!isDown)return;el.style.left=(e.clientX-offsetX)+'px';el.style.top=(e.clientY-offsetY)+'px';};}
makeDraggable(document.getElementById("inputsUI"));

// Full-screen video logic
const fullScreenVideo=document.getElementById("fullScreenVideo");
const inputBtns=document.querySelectorAll("#inputsUI .input-btn");
inputBtns.forEach(btn=>{btn.addEventListener("click",()=>{const src=btn.dataset.src;fullScreenVideo.src=src;fullScreenVideo.style.display="block";fullScreenVideo.play();});});

// Exit full-screen on ESC, Backspace, or click
document.addEventListener("keydown",e=>{if(fullScreenVideo.style.display==="block"){if(e.key==="Escape"||e.key==="Backspace"){fullScreenVideo.pause();fullScreenVideo.style.display="none";fullScreenVideo.src="";}}});
fullScreenVideo.addEventListener("click",()=>{fullScreenVideo.pause();fullScreenVideo.style.display="none";fullScreenVideo.src="";});
</script>
<!-- Fullscreen video container -->
<video id="fullScreenVideo" autoplay style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:999;" ></video>

<!-- DIALOG WIDGETS (hidden until opened) -->
<div id="pcmDialog" class="widget dialog" data-widget style="display:none">
  <div class="title" data-drag-handle>
    <h1>PCM Sounds</h1>
    <div class="actions"><div class="icon" id="closePcm">‚úï</div></div>
  </div>
  <div class="controls" id="pcmButtons"></div>
</div>

<div id="tvHotkeyDialog" class="widget dialog" data-widget style="display:none">
  <div class="title" data-drag-handle>
    <h1>TVHotkey Menu</h1>
    <div class="actions"><div class="icon" id="closeHotkey">‚úï</div></div>
  </div>
  <div class="controls" id="tvHotkeyButtons"></div>
</div>

<div id="otherDialog" class="widget dialog" data-widget style="display:none">
  <div class="title" data-drag-handle>
    <h1>Other Menu</h1>
    <div class="actions"><div class="icon" id="closeOther">‚úï</div></div>
  </div>
  <div class="controls" id="otherButtons"></div>
</div>

<!-- LOG -->
<pre id="log"></pre>

<!-- external scripts (kept as-is) -->
<script src="wsproxy.js"></script>
<script src="client.js"></script>

<script>
/* --------------------------
   Core: Logging & SSAP client
   --------------------------*/
let client, currentVolume = 10, isMuted = false, selectedBtn = null;
function log(m){
  const L = document.getElementById('log');
  L.textContent = '[' + new Date().toLocaleTimeString() + '] ' + m + '\n' + L.textContent;
  // keep log length reasonable
  if(L.textContent.length > 20000) L.textContent = L.textContent.slice(0,20000);
}

/* SSAP client init (unchanged) */
async function initClient(){
  if(client) return;
  try{
    client = new SSAPClient('127.0.0.1', localStorage['client-key-127.0.0.1']);
    await client.connect();
    localStorage['client-key-127.0.0.1'] = await client.register();
  }catch(e){ log('SSAP init error: '+e); }
}

/* mapSsapToLuna and sendReq preserved but hardened for undefined webOS */
function mapSsapToLuna(uri){
  if(uri.startsWith('luna://')){ const p = uri.replace('luna://','').split('/'); return { service:'luna://'+p[0], method:p.slice(1).join('/') } }
  const path = uri.replace('ssap://',''); const parts = path.split('/'); let domain = parts[0], method = parts.slice(1).join('/');
  if(domain==='system.launcher') domain='com.webos.applicationManager';
  else if(domain==='system.notifications') domain='com.webos.notification';
  else if(domain==='audio') domain='com.webos.audio';
  return { service:'luna://'+domain, method };
}
function sendReq(uri, payload={}){
  const ua = navigator.userAgent || '';
  const isC53 = ua.includes('Chrome/53');
  if(isC53 && window.webOS && webOS.service){
    const {service, method} = mapSsapToLuna(uri);
    webOS.service.request(service, { method, parameters: payload,
      onSuccess: (r)=> log('OK '+method),
      onFailure: (e)=> log('ERR '+(e && (e.errorText || e)) )
    });
  } else {
    (async()=>{
      try{
        if(!client) await initClient();
        await client.request({uri, payload});
        log('OK ' + uri);
      }catch(e){ log('ERR ' + (e && e.toString())); }
    })();
  }
}

/* --------------------------
   Actions (unchanged)
   --------------------------*/
async function launchApp(id){ sendReq('ssap://system.launcher/launch', {id}) }
async function volumeUp(){ currentVolume++; currentVolume = Math.min(100, currentVolume); sendReq('ssap://audio/setVolume',{volume:currentVolume}); updateVolUI(); }
async function volumeDown(){ currentVolume = Math.max(0, currentVolume-1); sendReq('ssap://audio/setVolume',{volume:currentVolume}); updateVolUI(); }
async function toggleMute(){ isMuted = !isMuted; sendReq('ssap://audio/setMute',{mute:isMuted}); updateVolUI(); }
function sendKey(el){ const key = el.dataset.key; sendReq('ssap://com.webos.service.tvinput/sendKeyEvent',{key}); log('Key '+key); }
function closeWidget(el){ el.style.display='none'; }

/* update numeric displayed values */
function updateVolUI(){
  document.getElementById('volVal').textContent = currentVolume;
  document.getElementById('muteVal').textContent = isMuted;
  log('Volume ' + currentVolume + (isMuted? ' (muted)':'' ));
}

/* --------------------------
   Draggable system (generic)
   - widgets with [data-widget]
   - drag handle = child with [data-drag-handle]
   --------------------------*/
(function makeDraggable(){
  const widgets = document.querySelectorAll('[data-widget]');
  widgets.forEach(w=>{
    const handle = w.querySelector('[data-drag-handle]') || w;
    handle.style.touchAction = 'none';
    let dragging=false, startX=0, startY=0, origLeft=0, origTop=0;
    handle.addEventListener('mousedown', startDrag);
    handle.addEventListener('touchstart', startDrag, {passive:false});
    function startDrag(e){
      e.preventDefault();
      dragging = true;
      const ev = e.touches ? e.touches[0] : e;
      startX = ev.clientX; startY = ev.clientY;
      // get computed pos; if not set convert right/transform to left
      const rect = w.getBoundingClientRect();
      origLeft = rect.left + window.scrollX;
      origTop = rect.top + window.scrollY;
      w.style.transition = 'none';
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', endDrag);
      document.addEventListener('touchmove', onMove, {passive:false});
      document.addEventListener('touchend', endDrag);
    }
    function onMove(e){
      if(!dragging) return;
      const ev = e.touches ? e.touches[0] : e;
      const dx = ev.clientX - startX;
      const dy = ev.clientY - startY;
      const newLeft = Math.max(6, Math.min(window.innerWidth - w.offsetWidth - 6, origLeft + dx));
      const newTop = Math.max(6, Math.min(window.innerHeight - w.offsetHeight - 6, origTop + dy));
      w.style.left = newLeft + 'px';
      w.style.top = newTop + 'px';
      // clear right/transform so position is explicit
      w.style.right = 'auto';
      w.style.transform = 'none';
      // ensure visible z
      w.style.zIndex = 200;
      e.preventDefault();
    }
    function endDrag(){
      dragging = false;
      // small transition back to natural look
      w.style.transition = 'box-shadow .2s';
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', endDrag);
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('touchend', endDrag);
    }
  });
})();

/* --------------------------
   Setup dialog buttons & open/close
   --------------------------*/
function setupDialogButtons(containerId, arr){
  const c = document.getElementById(containerId);
  c.innerHTML = '';
  arr.forEach(opt=>{
    const b = document.createElement('button');
    b.className = 'btn small';
    b.textContent = opt.label;
    b.dataset.key = opt.key || '';
    b.onclick = ()=> {
      if(opt.key) { sendReq('ssap://com.webos.service.tvinput/sendKeyEvent',{key:opt.key}); log('Key '+opt.key); }
      else if(opt.onclick) { sendReq(opt.onclick, opt.params || {}); }
    };
    c.appendChild(b);
  });
}

/* PCM */
const pcmSounds=[
  {label:'Power On',name:'power-on'},{label:'Power Off',name:'power-off'},{label:'Welcome',name:'welcome'},
  {label:'FU Fail',name:'first-use-fail'},{label:'FU Success',name:'first-use-success'},
  {label:'Input Detected',name:'input-detected'},{label:'Voice Start',name:'voicestart'},
  {label:'Voice Confirm',name:'voiceconfirm'},{label:'Voice Cancel',name:'voicecancel'},{label:'Loading',name:'loading'}
];
document.getElementById('pcmBtn').onclick = ()=>{
  setupDialogButtons('pcmButtons', pcmSounds.map(s=>({label:s.label, onclick:'ssap://com.webos.audio/systemsounds/playFeedback', params:{play:true, sink:'pfeedback', name:s.name}})));
  openWidget('pcmDialog', {rightOffset:280, topOffset:10});
};

/* TVHotkey */
const tvHotkeyButtons=[
  {label:'Home',key:'HOME'},{label:'FullHome',key:'FULL_HOME'},
  {label:'Energy Saving',onclick:'ssap://com.webos.service.applicationManager/launch',params:{id:'com.webos.app.tvhotkey',params:{activateType:'energy-saving-mode'}}},
  {label:'Aspect Ratio',onclick:'ssap://com.webos.service.applicationManager/launch',params:{id:'com.webos.app.tvhotkey',params:{activateType:'aspect-ratio'}}},
  {label:'Store Mode',onclick:'ssap://com.webos.service.applicationManager/launch',params:{id:'com.webos.app.tvhotkey',params:{activateType:'store-mode'}}},
  {label:'Soccer Mode',onclick:'ssap://com.webos.service.applicationManager/launch',params:{id:'com.webos.app.tvhotkey',params:{activateType:'soccer-mode'}}},
  {label:'Sleep Timer',onclick:'ssap://com.webos.service.applicationManager/launch',params:{id:'com.webos.app.tvhotkey',params:{activateType:'sleep'}}},
  {label:'Subtitle',onclick:'ssap://com.webos.service.applicationManager/launch',params:{id:'com.webos.app.tvhotkey',params:{activateType:'subtitle'}}},
  {label:'SIMPLINK',onclick:'ssap://com.webos.service.applicationManager/launch',params:{id:'com.webos.app.tvhotkey',params:{activateType:'simplink'}}},
  {label:'3D Mode',onclick:'ssap://com.webos.service.applicationManager/launch',params:{id:'com.webos.app.tvhotkey',params:{activateType:'3d-mode'}}},
  {label:'One Local Key',onclick:'ssap://com.webos.service.applicationManager/launch',params:{id:'com.webos.app.tvhotkey',params:{activateType:'one-local-key'}}},
  {label:'Local Key Menu',onclick:'ssap://com.webos.service.applicationManager/launch',params:{id:'com.webos.app.tvhotkey',params:{activateType:'local-key'}}},
  {label:'Multi Audio',onclick:'ssap://com.webos.service.applicationManager/launch',params:{id:'com.webos.app.tvhotkey',params:{activateType:'multi-sound-setting'}}},
  {label:'Audio Description',onclick:'ssap://com.webos.service.applicationManager/launch',params:{id:'com.webos.app.tvhotkey',params:{activateType:'audio-description'}}},
  {label:'Screenshot',onclick:'luna://org.webosbrew.hbchannel.service/exec',params:{command:'/media/developer/apps/usr/palm/applications/org.set.app/screenshot-flow.sh'}}
];
document.getElementById('tvHotkeyMenuBtn').onclick = ()=>{
  setupDialogButtons('tvHotkeyButtons', tvHotkeyButtons);
  openWidget('tvHotkeyDialog', {leftOffset:280, topOffset:12});
};

/* Other menu */
const otherButtons=[
  {label:'BeanBrowser',onclick:'ssap://com.webos.applicationManager/launch',params:{id:'com.webos.app.beanbrowser',params:{contentTarget:'https://m.youtube.com',ui:['Exit'],x:100,y:350,width:500,height:700,overlay:true}}},
  {label:'Web Browser',onclick:'ssap://com.webos.applicationManager/launch',params:{id:'com.webos.app.browser'}},
  {label:'Web App',onclick:'ssap://com.webos.applicationManager/launch',params:{id:'com.webos.app.webapphost'}},
  {label:'Watch a Video',onclick:'ssap://com.webos.applicationManager/launch',params:{id:'com.webos.app.photovideo',params:{payload:[{fullPath:'/media/developer/apps/usr/palm/applications/com.m12c.tvhotkeymenu/aww.mp4',mediaType:'VIDEO',fileName:'Chickadee',thumbnail:'/usr/palm/applications/com.webos.app.cheeringtv/areaWhite.png',lastPlayPosition:-1}]}}},
  {label:'Play a Sound',onclick:'ssap://com.webos.applicationManager/launch',params:{id:'com.webos.app.music',params:{payload:[{fullPath:'/usr/palm/applications/com.webos.app.cheeringtv/assets/sounds/mono/fireworks.wav',mediaType:'MUSIC',deviceType:'DMR',fileName:'fireworks',thumbnail:'/usr/palm/applications/com.webos.app.cheeringtv/areaWhite.png',subtitle:'',lastPlayPosition:-1,album:'',artist:''}]}}}
];
document.getElementById('otherMenuBtn').onclick = ()=>{
  setupDialogButtons('otherButtons', otherButtons);
  openWidget('otherDialog', {leftOffset:280, topOffset:180});
};

/* openWidget tries to place widget near main controls without covering center */
function openWidget(id, opts){
  const w = document.getElementById(id);
  w.style.display = 'block';
  // position: try offsets, otherwise near center-right
  if(opts && opts.leftOffset !== undefined) { w.style.left = opts.leftOffset + 'px'; w.style.top = (opts.topOffset || 12) + 'px'; }
  else if(opts && opts.rightOffset !== undefined){ w.style.right = opts.rightOffset + 'px'; w.style.top = (opts.topOffset || 12) + 'px'; }
  else { w.style.right = '12px'; w.style.top = '12px'; }
  // ensure left/top computed for drag system
  setTimeout(()=>{ const rect = w.getBoundingClientRect(); w.style.left = (rect.left) + 'px'; w.style.top = (rect.top) + 'px'; w.style.right='auto'; }, 25);
}

/* close buttons */
document.getElementById('closePcm').onclick = ()=> document.getElementById('pcmDialog').style.display='none';
document.getElementById('closeHotkey').onclick = ()=> document.getElementById('tvHotkeyDialog').style.display='none';
document.getElementById('closeOther').onclick = ()=> document.getElementById('otherDialog').style.display='none';
document.getElementById('minMain').onclick = ()=> { const m = document.getElementById('mainControls'); m.style.display = (m.style.display==='none') ? 'block':'none'; }
document.getElementById('minVol').onclick = ()=> { const m = document.querySelector('#volumeUI .controls'); m.style.display = (m.style.display==='none') ? 'block':'none'; }

/* --------------------------
   Keyboard navigation across open widgets
   - ArrowUp/Down to move focus inside widget
   - Enter to activate focused button
   - Escape to close widget
   --------------------------*/
document.addEventListener('keydown', (e)=>{
  const widgetIds = ['pcmDialog','tvHotkeyDialog','otherDialog','mainUI','volumeUI'];
  for(const id of widgetIds){
    const w = document.getElementById(id);
    if(w && w.style.display!=='none'){
      const btns = w.querySelectorAll('button');
      if(!btns || btns.length===0) continue;
      if(!selectedBtn || !Array.from(btns).includes(selectedBtn)) selectedBtn = btns[0];
      if(e.key === 'ArrowDown'){ e.preventDefault(); focusNext(btns); break; }
      if(e.key === 'ArrowUp'){ e.preventDefault(); focusPrev(btns); break; }
      if(e.key === 'Enter'){ e.preventDefault(); selectedBtn.click(); break; }
      if(e.key === 'Escape'){ if(w.classList.contains('dialog') || id==='mainUI' || id==='volumeUI'){ w.style.display='none'; selectedBtn=null; } break; }
    }
  }
});
function focusNext(btns){ let i=[...btns].indexOf(selectedBtn); i=(i+1)%btns.length; selectedBtn=btns[i]; selectedBtn.focus(); }
function focusPrev(btns){ let i=[...btns].indexOf(selectedBtn); i=(i-1+btns.length)%btns.length; selectedBtn=btns[i]; selectedBtn.focus(); }

/* initialize UI values and buttons */
updateVolUI();
setupDialogButtons('pcmButtons', pcmSounds.map(s=>({label:s.label, onclick:'ssap://com.webos.audio/systemsounds/playFeedback', params:{play:true,sink:'pfeedback',name:s.name}})));
setupDialogButtons('tvHotkeyButtons', tvHotkeyButtons);
setupDialogButtons('otherButtons', otherButtons);

/* expose small API for debugging */
window.__app = { sendReq, launchApp, volumeUp, volumeDown, toggleMute };

/* ensure widgets initial positions translate to left/top for dragging */
window.addEventListener('load', ()=> {
  document.querySelectorAll('[data-widget]').forEach(w=>{
    const rect = w.getBoundingClientRect();
    // if positioned with right/transform, convert to left/top for consistent dragging
    if(!w.style.left && (w.style.right || w.style.transform)){
      w.style.left = rect.left + 'px';
      w.style.top  = rect.top + 'px';
      w.style.right = 'auto';
      w.style.transform = 'none';
    }
  });
});
</script>



</body>
</html>

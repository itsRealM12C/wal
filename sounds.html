<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Volume + PCM</title>
<script src="https://dropbox.inf.re/webos-gfn/client.js"></script>
<script src="https://dropbox.inf.re/webos-gfn/wsproxy.js"></script>

<style>
body{margin:10px;font-family:Arial,sans-serif;background:#0b0b0b;color:#fff;}
.btn{display:block;width:180px;margin:4px 0;padding:8px;background:#303;border:2px solid #555;border-radius:8px;color:#fff;cursor:pointer;}
input{width:60px;padding:4px;margin-right:6px;border-radius:4px;border:1px solid #555;background:#111;color:#fff;}
#pcmButtons{margin-top:10px;}
</style>
</head>
<body>
<h1>Volume Control</h1>
<button class="btn" onclick="volumeUp()">Volume +</button>
<button class="btn" onclick="volumeDown()">Volume -</button>
<input type="text" id="volInput" placeholder="0">
<button class="btn" onclick="setVolume()">Set</button>
<button class="btn" onclick="toggleMute()">Mute</button>

<h1>PCM Sounds</h1>
<div id="pcmButtons"></div>
<div class="dialog" id="pcmDialog">
  <h2>PCM Sounds</h2>
  <div id="pcmButtons">
    <button class="btn" onclick="sendReq('ssap://com.webos.audio/systemsounds/playFeedback',{play:true,sink:'pfeedback',name:'power-on'})">Power On</button>
    <button class="btn" onclick="sendReq('ssap://com.webos.audio/systemsounds/playFeedback',{play:true,sink:'pfeedback',name:'power-off'})">Power Off</button>
    <button class="btn" onclick="sendReq('ssap://com.webos.audio/systemsounds/playFeedback',{play:true,sink:'pfeedback',name:'welcome'})">Welcome</button>
    <button class="btn" onclick="sendReq('ssap://com.webos.audio/systemsounds/playFeedback',{play:true,sink:'pfeedback',name:'first-use-fail'})">FU Fail</button>
    <button class="btn" onclick="sendReq('ssap://com.webos.audio/systemsounds/playFeedback',{play:true,sink:'pfeedback',name:'first-use-success'})">FU Success</button>
    <button class="btn" onclick="sendReq('ssap://com.webos.audio/systemsounds/playFeedback',{play:true,sink:'pfeedback',name:'input-detected'})">Input Detected</button>
    <button class="btn" onclick="sendReq('ssap://com.webos.audio/systemsounds/playFeedback',{play:true,sink:'pfeedback',name:'voicestart'})">Voice Start</button>
    <button class="btn" onclick="sendReq('ssap://com.webos.audio/systemsounds/playFeedback',{play:true,sink:'pfeedback',name:'voiceconfirm'})">Voice Confirm</button>
    <button class="btn" onclick="sendReq('ssap://com.webos.audio/systemsounds/playFeedback',{play:true,sink:'pfeedback',name:'voicecancel'})">Voice Cancel</button>
    <button class="btn" onclick="sendReq('ssap://com.webos.audio/systemsounds/playFeedback',{play:true,sink:'pfeedback',name:'loading'})">Loading</button>
  </div>
  <div class="close-btn" onclick="closeDialog('pcmDialog')">âœ• Close</div>
</div>
<script>
let currentVolume=10, isMuted=false;

// --- Universal SSAP/Luna sender
async function sendReq(uri,payload={}){
  const ua=navigator.userAgent;
  const isC53=ua.includes('Chrome/53');
  if(isC53 && window.webOS && webOS.service){
    const [service,method]=uri.replace(/^ssap:\/\//,'').split('/');
    webOS.service.request('luna://'+service,{
      method,
      parameters:payload,
      onSuccess:()=>log('OK '+method),
      onFailure:e=>log('ERR '+(e.errorText||JSON.stringify(e)))
    });
  }else{
    if(!window.client) window.client=new SSAPClient('127.0.0.1', localStorage['client-key-127.0.0.1']);
    if(!window.client.isConnected) await window.client.connect();
    localStorage['client-key-127.0.0.1']=await window.client.register();
    await window.client.request({uri,payload});
    log('OK '+uri);
  }
}

// --- Logging helper
function log(msg){
  const L=document.getElementById('log');
  L.textContent='['+new Date().toLocaleTimeString()+'] '+msg+'\n'+L.textContent;
}

// --- Volume actions
// --- Logging helper
function log(msg){
  const L=document.getElementById('log');
  L.textContent='['+new Date().toLocaleTimeString()+'] '+msg+'\n'+L.textContent;
}

// --- Universal SSAP/Luna sender
let client=null;
async function sendReq(uri,payload={}){
  const ua=navigator.userAgent;
  const isC53=ua.includes('Chrome/53');
  if(isC53 && window.webOS && webOS.service){
    const [service,method]=uri.replace(/^ssap:\/\//,'').split('/');
    webOS.service.request('luna://'+service,{
      method,
      parameters:payload,
      onSuccess:()=>log('OK '+method),
      onFailure:e=>log('ERR '+(e.errorText||JSON.stringify(e)))
    });
  } else {
    if(!client) client=new SSAPClient('127.0.0.1',localStorage['client-key-127.0.0.1']);
    if(!client.isConnected) await client.connect();
    localStorage['client-key-127.0.0.1']=await client.register();
    await client.request({uri,payload});
    log('OK '+uri);
  }
}

// --- Volume
let currentVolume=10,isMuted=false;
function setVolume(vol){
  currentVolume=vol;
  sendReq('ssap://audio/setVolume',{volume:currentVolume});
  log('Volume set to '+currentVolume);
}
function volumeUp(){setVolume(currentVolume+1);}
function volumeDown(){setVolume(Math.max(0,currentVolume-1));}
function toggleMute(){isMuted=!isMuted; sendReq('ssap://audio/setMute',{mute:isMuted}); log('Mute '+isMuted);}

// --- Volume setter input + set button
const volInput=document.createElement('input');
volInput.type='number';
volInput.style.width='60px';
volInput.value=currentVolume;
const setBtn=document.createElement('button');
setBtn.className='btn';
setBtn.textContent='Set';
setBtn.onclick=()=>{ 
  const val=parseInt(volInput.value);
  if(!isNaN(val)) setVolume(val); 
};
const mainUI=document.getElementById('mainUI');
mainUI.appendChild(volInput);
mainUI.appendChild(setBtn);

// --- PCM Sounds
const pcmSounds=[
  {label:'Power On',name:'power-on'},
  {label:'Power Off',name:'power-off'},
  {label:'Welcome',name:'welcome'},
  {label:'FU Fail',name:'first-use-fail'},
  {label:'FU Success',name:'first-use-success'},
  {label:'Input Detected',name:'input-detected'},
  {label:'Voice Start',name:'voicestart'},
  {label:'Voice Confirm',name:'voiceconfirm'},
  {label:'Voice Cancel',name:'voicecancel'},
  {label:'Loading',name:'loading'}
];
const pcmContainer=document.getElementById('pcmButtons');

// --- Pre-create PCM buttons (instant click)
pcmSounds.forEach(s=>{
  const b=document.createElement('button');
  b.className='btn';
  b.textContent=s.label;
  b.onclick=()=>sendReq('ssap://com.webos.audio/systemsounds/playFeedback',{
    play:true,sink:'pfeedback',name:s.name
  });
  pcmContainer.appendChild(b);
});

// --- Show PCM dialog instantly
document.getElementById('pcmBtn').onclick=()=>{ 
  document.getElementById('pcmDialog').style.display='block';
};
  
// --- PCM Sounds
const pcmSounds=[
  {label:'Power On',name:'power-on'},
  {label:'Power Off',name:'power-off'},
  {label:'Welcome',name:'welcome'},
  {label:'FU Fail',name:'first-use-fail'},
  {label:'FU Success',name:'first-use-success'},
  {label:'Input Detected',name:'input-detected'},
  {label:'Voice Start',name:'voicestart'},
  {label:'Voice Confirm',name:'voiceconfirm'},
  {label:'Voice Cancel',name:'voicecancel'},
  {label:'Loading',name:'loading'}
];

document.getElementById('pcmBtn').onclick=()=>{
  const container=document.getElementById('pcmButtons');
  container.innerHTML='';
  pcmSounds.forEach(s=>{
    const b=document.createElement('button');
    b.className='btn';
    b.textContent=s.label;
    b.onclick=()=>sendReq('ssap://com.webos.audio/systemsounds/playFeedback',{
      play:true, sink:'pfeedback', name:s.name
    });
    container.appendChild(b);
  });
  document.getElementById('pcmDialog').style.display='block';
};

// --- Volume setter input
const volInput=document.createElement('input');
volInput.type='number';
volInput.style.width='60px';
volInput.value=currentVolume;
volInput.oninput=()=>{ currentVolume=parseInt(volInput.value)||0; };
const setBtn=document.createElement('button');
setBtn.className='btn';
setBtn.textContent='Set';
setBtn.onclick=()=>{ setVolume(currentVolume); };
document.getElementById('mainUI').appendChild(volInput);
document.getElementById('mainUI').appendChild(setBtn);
</script>
</body>
</html>
